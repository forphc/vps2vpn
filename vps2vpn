#!/bin/bash

# vps2vpn Bootstrapper
# This script downloads the full vps2vpn project and executes the main installer.

# --- Configuration ---
REPO_OWNER="forphc"
REPO_NAME="vps2vpn"
BRANCH="main" # Or the specific branch/tag you want to use

# --- Helper Functions ---
_echo_info() { echo -e " [\033[1;32mi\033[0m] $1 "; }
_echo_error() { echo -e " [\033[1;31mX\033[0m] $1 "; }

# --- Pre-flight Checks ---
_echo_info "Checking for necessary tools (wget, unzip)..."
if ! command -v wget &> /dev/null || ! command -v unzip &> /dev/null; then
    _echo_error "Error: 'wget' and 'unzip' are required for this script to run."
    _echo_error "Please install them using 'apt-get install wget unzip' and try again."
    exit 1
fi

# --- Main Logic ---
_echo_info "Downloading the latest version of the script..."
cd $HOME
wget -qO ${REPO_NAME}.zip "https://github.com/${REPO_OWNER}/${REPO_NAME}/archive/refs/heads/${BRANCH}.zip"

if [ $? -ne 0 ]; then
    _echo_error "Failed to download the script archive. Please check your internet connection and the repository URL."
    exit 1
fi

_echo_info "Extracting the script..."
unzip -q ${REPO_NAME}.zip
rm ${REPO_NAME}.zip

# The unzipped folder is typically named 'reponame-branchname'
EXTRACTED_DIR="${REPO_NAME}-${BRANCH}"
if [ ! -d "$EXTRACTED_DIR" ]; then
    _echo_error "Extracted directory '$EXTRACTED_DIR' not found. The repository structure may have changed."
    exit 1
fi

cd "$EXTRACTED_DIR"

if [ ! -f "install.sh" ]; then
    _echo_error "Main installer script 'install.sh' not found in the repository."
    exit 1
fi

_echo_info "Executing the main installation script..."
echo "================================================="
chmod +x install.sh
bash install.sh

# The bootstrapper's job is done. The main script will handle the rest.
exit 0
